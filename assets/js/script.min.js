var key,keys,page,tld,domains,domain,started,conversations,conversation,loadingConversations,users,fetchingMessages,loadingMessages,socket,replying,imTyping,typingSent,lastTyped,sync,urlAction,settings={},messages=[],timeFormat="g:i A",dateFormat="F jS Y",typingDelay=2e3,typingSendDelay=1e3,typers={},avatars={},unexpandedLinks=[];let host=window.location.host,validDomains=["https://hnschat","https://hns.chat"],commands=["shrug","me","slap"];var actionString="ACTION ",root=document.querySelector(":root"),css=getComputedStyle($("html")[0]),isActive=!0,notificationSound=new Audio("/assets/sound/pop"),browser=getBrowser(),linkRegex=/<(?:(div|a) class=\"(?:inline )?(?:nick|channel|link))(?:.+?)>(?:.+?)<\/(?:div|a)>/,emojiCategories={Search:[],People:["Smileys & Emotion","People & Body"],Nature:["Animals & Nature"],Food:["Food & Drink"],Activities:["Activities"],Travel:["Travel & Places"],Objects:["Objects"],Symbols:["Symbols"],Flags:["Flags"]};function isMobile(){return"flex"===$(".header .left").css("display")}function log(e){console.log(e)}function rtrim(e,a){a=a?new RegExp(a+"+$"):new RegExp("\\s+$");return e.replace(a,"")}function ltrim(e,a){a=a?new RegExp("^"+a+"+"):new RegExp("^\\s+");return e.replace(a,"")}async function api(e){return key&&(e.key=key),new Promise(a=>{$.post("/api",JSON.stringify(e),e=>{e&&(e=JSON.parse(e),a(e))})})}async function upload(e,a){return new Promise(a=>{$.ajax({url:"/upload",type:"POST",data:e,cache:!1,contentType:!1,processData:!1,beforeSend:e=>{},xhr:()=>{var e=$.ajaxSettings.xhr();return e.upload.onprogress=()=>{},e},success:e=>{e=JSON.parse(e);a(e)}})})}function ws(e,a){socket.send(e+" "+JSON.stringify(a))}function startSession(){if(!key)return api({action:"startSession"})}function addDomain(e){return api({action:"addDomain",domain:toASCII(e)})}function listTLD(){return api({action:"listTLD"})}function checkTLD(e){return api({action:"checkTLD",tld:toASCII(e)})}function addSLD(e,a){let s={action:"addSLD",sld:toASCII(e),tld:toASCII(a)};return"undefined"!=typeof invite&&invite.length&&(s.invite=invite),api(s)}function verifyDomain(e){return api({action:"verifyDomain",domain:e})}function getDomains(){return api({action:"getDomains"})}function deleteAttachment(e){return api({action:"deleteAttachment",id:e})}function markConversationUnreadIfNeeded(e){var a;e!==conversation&&((a=conversations[e]).unreadMessages&&$("#conversations tr[data-id="+e+"]").addClass("unread"),a.unreadMentions&&$("#conversations tr[data-id="+e+"]").addClass("mentions")),updateMessageTabs()}function updateSearchView(){$("#users .title .searching").is(":visible")?($("#users .title .normal").removeClass("hidden"),$("#users .title .searching").removeClass("shown"),$("#users #count").removeClass("hidden"),$("#users input[name=search]").val(""),updateUsers()):($("#users .title .normal").addClass("hidden"),$("#users .title .searching").addClass("shown"),$("#users #count").addClass("hidden"),$("#users input[name=search]").focus())}function searchUsers(s){var e=$("#users tr.user");$.each(e,(e,a)=>{Array.from(toUnicode($(a).data("name").toString())).slice(0,Array.from(s).length).join("").toLowerCase()==s.toLowerCase()?$(a).removeClass("hidden"):$(a).addClass("hidden")})}function insertConversations(){var e=Object.entries(conversations).sort((e,a)=>e[1].latestMessage.time>a[1].latestMessage.time?-1:1),s={};$(e).each((e,a)=>{s[a[0]]=a[1]}),conversations=s,$("#conversations .section table").empty(),$.each(conversations,(e,a)=>{var s;isGroup(e)?(s=a.name,$("#conversations .channels table").append(conversationRow(e,s))):(s=Object.keys(a.users).filter(e=>e!==domain).join(", "),a=a.users[s],$("#conversations .private table").append(conversationRow(e,a)),updateAvatars()),decryptConversationSubtitle(e),markConversationUnreadIfNeeded(e)}),conversation?activeConversation(conversation):Object.keys(conversations).length?(inputEnabled(!0),activeConversation(Object.keys(conversations)[0])):inputEnabled(!1,"empty"),onLoadAction(urlAction)}function toASCII(e){return nameToAscii(e)}function toUnicode(e){e=punycode.ToUnicode(e);return nameToUnicode(e)}function updateConversation(s){var s=s.conversation,t=conversations[s].latestMessage;let n=$("#conversations .section table tr[data-id="+s+"]");if(n){let e=n.parent(),a=(n.remove(),n.find(".subtitle"));var i=isGroup(s)?toUnicode(nameForUserID(t.user).domain):toUnicode(conversations[s].users[t.user].domain),t=t.message;a.html(i+'<span class="decrypt">'+t+"</span>"),e.prepend(n)}decryptConversationSubtitle(s),markConversationUnreadIfNeeded(s)}function updateUsers(){var t,e;$("#users .searching.shown").length||($(".users table").empty(),isGroup(conversation)&&(t=[],e=conversations[conversation].users,$.each(Object.keys(e),(e,a)=>{var s=users.filter(e=>e.id==a);s.length&&!s[0].locked&&(s=s[0],conversations[conversation].users[s.id]={domain:s.domain},s={id:s.id,domain:s.domain},t.push(s))}),$.each(t,(e,a)=>{a=userRow(a);$(".users table").append(a)}),$("#users #count").html(t.length.toLocaleString("en-US")),updateAvatars()))}function updateAvatars(){$.each($(".favicon:not(.loaded)"),(e,s)=>{let t=$(s);t.addClass("loaded");var n;t.data("domain");let i=t.data("id"),o=nameForUserID(i);if(o.id)if(Object.keys(avatars).includes(i)){if(avatars[i]){let a=$("#avatars .favicon[data-id="+i+"]");if(a.length){s=a[0].cloneNode(!0);let e=t.parent();t.remove(),e.append(s),e.find(".fallback").html(""),updateOtherAvatars(i)}}}else if(avatars[i]=!1,o.avatar){n="/avatar/"+o.id;let e=$('<img class="loading" />');e.attr("src",n).on("load",e=>{let a=$(e.target);t.css("background-image","url("+n+")"),t.parent().find(".fallback").html(""),a.remove(),avatars[i]=n;e=t[0].cloneNode(!0);$("#avatars").append(e),updateOtherAvatars(o.id)}).on("error",e=>{$(e.target).remove(),avatars[i]=!1}),$("html").append(e)}else avatars[i]=!1})}function updateOtherAvatars(n){var e;avatars[n]&&(e=[$("#conversations .section.private .avatar .favicon[data-id="+n+"].loaded"),$("#messages .messageRow .avatar .favicon[data-id="+n+"].loaded"),$("#users .user .avatar .favicon[data-id="+n+"].loaded")],$.each(e,(e,s)=>{if(s.length&&("none"===s.css("background-image")||!s.css("background-image"))){let a=$("#avatars .favicon[data-id="+n+"]");if(a.length){var t=a[0].cloneNode(!0);let e=s.parent();s.remove(),e.append(t),e.find(".fallback").html("")}}}))}async function makeSecret(s){return new Promise(a=>{var e=getOtherUser(s),e=JSON.parse(e.pubkey);e?deriveKey(e,keys.privateKeyJwk).then(e=>{conversations[s].key=e,decryptConversationSubtitle(s),a(e)}):a()})}function getUsers(){return api({action:"getUsers"})}function loadConversations(){loadingConversations=!0,getConversations(domain).then(e=>{conversation=null,$("#messages").empty(),$(".messageHeader table").empty(),$("#conversations .private table").empty(),e.success&&(conversations=e.conversations,conversation=Object.keys(conversations).filter(e=>conversations[e].group&&"general"===conversations[e].name),updateUsers(),Object.keys(conversations).includes(localStorage.conversation)?conversation=localStorage.conversation:localStorage.setItem("conversation",conversation),messageTabForConversation(conversation),setupConversations().then(()=>{insertConversations()})),loadingConversations=!1})}async function setupConversations(){var t=0;let n=Object.keys(conversations).filter(e=>!conversations[e].group);return new Promise(s=>{$.each(conversations,(e,a)=>{a.group?(e==conversation&&(updateUsers(),loadMessages(conversation)),t==n.length&&s()):makeSecret(e).then(()=>{t+=1,e==conversation&&loadMessages(conversation),t==n.length&&s()})})})}function getConversations(e){return api({action:"getConversations",domain:e})}function loadMessages(d,a={}){fetchingMessages=!0,getMessages(d,a).then(i=>{if($("#chats .content .needSLD").remove(),fetchingMessages=!1,i.success){var s=!1,e=(a.before&&(s=!0),i.messages);loadingMessages=e.length,$.each(e,(e,a)=>{prepareMessage(a,!0,s)}),s||fixScroll(),conversations[d].unreadMessages=0,conversations[d].unreadMentions=0}else{let s=$('<div class="needSLD" />'),e=$("<span />"),t=$('<div class="button" />'),n=toUnicode(conversations[d].name);var o=[],r="";let a=new Promise(s=>{i.unverified?(r="You need to verify your name to chat here.",t.attr("data-action","verifyName"),t.html("Verify my name"),s()):i.needSLD&&(r="#"+n+" is a private community for owners of a ."+n+" only.",checkTLD(n).then(e=>{var a="";e.success&&(e.free?(a="Create a free .",t.attr("data-action","createSLD")):e.purchase&&(a="Purchase a .",t.attr("data-action","purchaseSLD")),e.owned&&$.each(e.owned,(e,a)=>{let s=$('<div class="button" />');var t=toUnicode(nameForUserID(a).domain);s.html("Switch to "+t),s.attr("data-id",a),s.attr("data-action","switchName"),o.push(s)}),a.length&&(t.html(a+n),t.attr("data-tld",n))),s()}))});a.then(()=>{r.length&&(e.html(r),s.append(e),t.html().length&&s.append(t),o.length&&$.each(o,(e,a)=>{s.append(a)}),$("#chats .content .needSLD").remove(),$("#chats .content").append(s))})}showChat(!0)})}function getMessages(e,a){let s={action:"getMessages",conversation:e,domain:domain};return $.each(a,(e,a)=>{s[e]=a}),api(s)}function fixScroll(e=!1,a){if(("safari"===browser?!0:!1)&&!e){let e=$("#messageHolder");e[0].scrollTop||(e.scrollTop(-1),e.scrollTop(0))}}function isCharEmoji(a){return"‍"==a||!!emojis.filter(e=>e.emoji==a||e.emoji.replace("️","")==a).length}function setContextMenuPosition(e,a){var s=window.innerWidth/2,t=window.innerHeight/2,n=a.clientX,i=a.clientY;s<=n&&(n=a.clientX-e.outerWidth()),t<=i&&(i=a.clientY-e.outerHeight()),e.css({top:i,left:n})}function setupEmojiView(t,e){let i=$(".popover[data-name=emojis]");if("message"===e){let e=$(t.currentTarget),a=e.closest(".messageRow");var n;a.length||(n=e.closest(".body").find("span.message").data("id"),a=$("#messages").find(".messageRow[data-id="+n+"]"));let s=a.find(".hover");s.addClass("visible"),i.addClass("react"),setContextMenuPosition(i,t)}else i.removeClass("react"),i.css({top:"auto",left:"10px"});i.hasClass("loaded")||(i.attr("data-sender",e),$.each(Object.keys(emojiCategories),(e,a)=>{let s=$('<div class="section" />'),t=$('<div class="subtitle" />');var n=$('<div class="emojis" />');s.attr("data-name",a),t.html(a),s.append(t),s.append(n),0==e&&(s.addClass("hidden"),t.addClass("hidden")),i.find(".body .grid").append(s)}),$.each(emojis,(e,a)=>{var s=categoryForEmoji(a);let t=$('<div class="emoji" />');t.attr("data-aliases",JSON.stringify(a.aliases)),t.html(a.emoji),i.find(".body .grid .section[data-name="+s+"] .emojis").append(t)}),i.addClass("loaded"))}function decodeEntities(e){var a=document.createElement("textarea");return a.innerHTML=e,a.value}function nameForUserInConversation(e,a){return isGroup(e)?toUnicode(nameForUserID(a).domain):toUnicode(conversations[e].users[a].domain)}function replaceIds(e,n=!0){var i=e,e=new regex(/\@(?<name>[a-zA-Z0-9]{16})/,"gm"),e=i.matchAll(e).reverse();return $.each(e,(e,a)=>{var s=a.groups.name,t=a.index,a=a.index+s.length+1;nameForUserID(s)&&(s=toUnicode(nameForUserID(s).domain),i=replaceRange(i,t,a,n?'<div class="inline nick">@'+s+"/</div>":"@"+s+"/"))}),i}function replaceNames(e){var a=e;let s=new RegExp("@(?<name>[^ ]+?/)");for(;null!==(result=s.exec(a));){var t=result.groups.name,n=result.index,i=result.index+t.length+1,o=users.filter(e=>toUnicode(e.domain)==rtrim(t,"/")&&!e.locked);o&&(a=replaceRange(a,n,i,"@"+o[0].id))}return a}async function messageBody(s){return new Promise(a=>{var e;isGroup(s.conversation)?a(s.message.trim()):(e=conversations[s.conversation].key,decryptMessage(s.message,e,s.conversation).then(e=>{a(e.trim())}))})}function prepareMessage(o,r=!0,d=!1){messageBody(o).then(e=>{var a=!1,s=(o.reactions=JSON.parse(o.reactions),d?messages.unshift(o):messages.push(o),new Date(1e3*o.time).format(dateFormat)),t=new Date(1e3*o.time).format(timeFormat),n="",i=(o.from?n=o.from:o.user&&(n=o.user),nameForUserInConversation(o.conversation,n));fetchingMessages||(o.conversation==conversation?(insertMessage(o,e,d,n,i,s,t),isActive||(a=!0)):a=!0,!r&&a&&n!==domain&&(s=replaceIds(e,!1),isGroup(o.conversation)?e.includes("@"+domain)&&sendNotification(i+" - #"+conversations[o.conversation].name,s,o.conversation):sendNotification(i,s,o.conversation)))})}function insertMessage(r,s,t,n,i,o,d){var c=$("#messages > .messageRow[data-id="+r.id+"]");if(!c.length){let e=$("#messages");var l=$('<div class="messageRow" />'),c=$('<div class="contents" />'),m=$('<div class="holder" />'),v=$('<div class="message" />'),p=$('<div class="body" />'),u=$('<div class="holder react" />'),g=$('<div class="reactions" />'),h=$('<div class="hover" />'),f=$('<div class="actions" />'),y=$('<div class="action icon reply" data-action="reply" />'),b=$('<div class="action icon emoji" data-action="emojis" />'),C=($('<div class="action icon delete" data-action="deleteMessage" />'),$('<div class="time" />')),k=$('<div class="signature" />'),w=$('<div class="user" />');$('<div class="user" />');if(C.html(d),w.html(i+"/"),l.attr("data-id",r.id),l.attr("data-time",r.time),l.attr("data-sender",n),l.attr("title",o),n!=domain&&r.user!=domain||l.addClass("self"),r.replying){l.addClass("replying");let s=$('<div class="reply" />'),t=$('<div class="line" />'),n=$('<div class="contents" />'),i=$('<div class="user" />'),o=$('<div class="body" />');domain==r.replying.user&&l.addClass("mention");d=nameForUserInConversation(r.conversation,r.replying.user);i.html(d+"/"),messageBody(r.replying).then(e=>{var a;a=replaceSpecialMessages(replaceIds(decodeEntities(decodeEntities(e)),!1),!1),o.attr("title",a),o.html(htmlEntities(a)),isAction(e)&&o.addClass("action"),n.prepend(i),n.append(o),s.append(t),s.append(n),l.prepend(s)})}isAction(s)&&(l.addClass("action"),s=s.substring(8));d=decodeEntities(decodeEntities(s));let a=Array.from(d);var d=a.slice(0,3),S=!0,d=($.each(d,(e,a)=>{isCharEmoji(a)||(S=!1)}),S&&l.addClass("emojis"),r.signature&&!r.signed?(v.addClass("signed fail"),v.attr("data-signature",r.signature),k.html(r.signature)):r.signed&&(v.addClass("signed"),v.attr("data-signature",r.signature),k.html(r.signature)),!1);try{var D=decodeEntities(decodeEntities(s));let i=JSON.parse(D);if(i.hnschat)if(i.attachment){var d=!0,O="https://"+host+"/uploads/"+i.attachment;let e=$("<a />"),a=(e.attr("href",O),e.attr("target","_blank"),$("<img />"));a.attr("src",O),e.append(a),p.append(e),v.addClass("image")}else if(i.payment){d=!0;var T="https://niami.io/tx/"+i.payment;let e=$("<a />"),a=(e.attr("href",T),e.attr("target","_blank"),$("<img />")),s=(a.attr("src","/assets/img/icon-512x512"),$('<div class="imageHolder" />')),t=(s.append(a),$('<div class="amount" />')),n=(t.html(rtrim(i.amount.toLocaleString("en-US",{minimumFractionDigits:6}),"0")),s.append(t),$('<div class="txMessage" />'));n.html("You've received a payment. Click for transaction details."),s.append(n),e.append(s),p.append(e),v.addClass("image payment")}}catch(e){}d||(isGroup(r.conversation)?p.html(s):p.html(htmlEntities(htmlEntities(s)))),f.append(y),f.append(b),v.append(p),v.append(k),m.append(v),u.append(g),h.append(C),h.append(f),l.hasClass("self")?m.prepend(h):m.append(h),c.append(m),c.append(u),t?(t={oldHeight:e[0].scrollHeight,oldPosition:e[0].scrollTop},e.prepend(l)):e.append(l),r.firstMessage&&((D=$('<div class="messageRow informational date last" />')).html(o),e.prepend(D),c.prepend(w),c.prepend(messageAvatar(n,i)),stylizeMessage(D)),l.append(c),fixScroll(t,l),setTimeout(()=>{--loadingMessages},1),d||linkifyMessage(p);O=messages.filter(e=>r.id==e.id);O.length&&updateReactions(O[0]),stylizeMessage(l),updateAvatars()}}function stylizeMessage(e){$("#messages");let a=$("#messages > .messageRow[data-id]").first();var s=a.data("id");let t=$("#messages > .messageRow[data-id]").last();var n=t.data("id"),i=e.data("id"),o=e.data("time"),r=new Date(1e3*o).format(dateFormat);let d=e.find(".contents");var c=e.data("sender");let l=e.prev();var m=l.data("time"),v=new Date(1e3*m).format(dateFormat),p=l.data("sender");let u=e.next();var g,h,f,y=u.data("time"),b=new Date(1e3*y).format(dateFormat),C=u.data("sender"),k=!1,w=!1,S=!1,D=!1,O=!1,T=!1,A=!1,M=!1,j=!1,I=!1,U=!1;s==i&&(k=!0),n==i&&(w=!0),e.hasClass("replying")&&(S=!0),e.hasClass("informational"),e.hasClass("date")&&(D=!0),e.hasClass("action"),(k||S)&&(T=!0),(O=u.length?!0:O)?D||!u.length||r===b||u.hasClass("date")||(U=!0):D||!l.length||r===v||l.hasClass("date")||(I=!0),D?(l.addClass("last"),e.addClass("first last"),u.length&&(A=!0)):(s=nameForUserInConversation(conversation,c),O?e.addClass("first"):e.addClass("last"),(k||S)&&e.addClass("first"),w&&e.addClass("last"),l.length&&(60<(g=o-m)||p!==c?(l.addClass("last"),e.addClass("first"),T=!0):S||(M=!0)),g<60&&p==c&&!e.hasClass("replying")&&l.removeClass("last"),p!==c&&l.addClass("last"),u.length&&(60<(g=y-o)&&(u.addClass("first"),A=!0),u.hasClass("first")&&e.addClass("last")),g<60&&C==c&&!u.hasClass("replying")&&(j=!0),T&&!d.find(".user").length&&((f=$('<div class="user" />')).html(s+"/"),d.prepend(f),d.prepend(messageAvatar(c,s))),M&&(e.removeClass("first"),e.find(".contents .user").remove(),e.find(".contents .avatar").remove()),j&&(e.removeClass("last"),u.removeClass("first"),u.find(".contents .user").remove(),u.find(".contents .avatar").remove()),I&&((h=$('<div class="messageRow informational date last" />')).html(r),h.insertBefore(e),stylizeMessage(h)),U&&((h=$('<div class="messageRow informational date last" />')).html(b),h.insertAfter(e),stylizeMessage(h))),A&&!u.find(".contents .user").length&&(n=nameForUserInConversation(conversation,C),(f=$('<div class="user" />')).html(n+"/"),u.addClass("first"),u.find(".contents").prepend(f),u.find(".contents").prepend(messageAvatar(C,n))),updateAvatars()}function replaceRange(e,a,s,t){return e.substr(0,a)+t+e.substr(s,e.length-s)}class regex extends RegExp{[Symbol.matchAll](e){e=RegExp.prototype[Symbol.matchAll].call(this,e);return e?Array.from(e):null}}function isIn(e,a,n,s){var t,i=!1,e=("link"===e&&(t=new regex(linkRegex,"gim")),a.matchAll(t).reverse());return $.each(e,(e,a)=>{var s=a[0],t=a.index,a=a.index+s.length;t<=n&&n<a&&(i=!0)}),i}function mentionsMe(e){var s=!1,a=new regex(/\@(?<name>[a-zA-Z0-9]{16})/,"gm"),e=e.matchAll(a);return $.each(e,(e,a)=>{domain==a.groups.name&&(s=!0)}),s}function linkifyMessage(e){var t=e.text(),a=anchorme.list(t).reverse(),a=($.each(a,(e,a)=>{var s=a.string,s=(a.isEmail?s="mailto:"+s:a.isURL&&"https://"!==s.substring(0,8)&&"http://"!==s.substring(0,7)&&(s="http://"+s),'<a class="inline link" href="'+s+'" target="_blank">'+a.string+"</a>");t=replaceRange(t,a.start,a.end,s)}),mentionsMe(t));a&&e.closest(".messageRow").addClass("mention"),t=replaceIds(t),e.html(t),expandLinks(e)}function expandLinks(e){let r=e.parent();var a=e.find("a.inline");if(a.length){let o=a[0].href;api({action:"getMetaTags",url:o}).then(i=>{if(i.tags&&Object.keys(i.tags).length){if(Object.keys(i.tags).includes("title")){let e=$('<a href="'+o+'" target="_blank" />'),a=$('<div class="preview" />'),s=$('<img class="image" />'),t=$('<div class="title" />'),n=$('<div class="subtitle" />');Object.keys(i.tags).includes("image")&&i.tags.image.length&&(s.attr("src",decodeEntities(decodeEntities(i.tags.image))),a.append(s)),i.tags.title.length&&(t.text(decodeEntities(decodeEntities(i.tags.title))),a.append(t)),Object.keys(i.tags).includes("description")&&i.tags.description.length&&(n.text(decodeEntities(decodeEntities(i.tags.description))),a.append(n)),a.html().length&&(e.append(a),r.append(e),fixScroll())}}else unexpandedLinks.includes(e)||(unexpandedLinks.push(e),setTimeout(()=>{expandLinks(e)},1e3))})}}function checkName(e,a){return api({action:"checkName",from:domain,domain:a})}async function encryptIfNeeded(e,s,t){return new Promise(a=>{t?encryptMessage(s,t,e).then(e=>{a(e)}):a(s)})}function sendMessage(s,a,t=!1){var e=conversations[s].key||null,n=a;if("/"===a[0])if(1<a.length&&"/"!==a[1]){let e=a.substring(1);var i=e.split(" "),o=i[0],r=(i.shift(),i.join(" "));switch(o){case"me":if(!r.length)return;n=actionString+r;break;case"shrug":n="¯\\_(ツ)_/¯";break;case"slap":if(!r.length)return;var d=rtrim(i[0],"[/ ]"),c=Object.keys(conversations[s].users).filter(e=>d.toLowerCase()==nameForUserID(e).domain.toLowerCase());if(!c.length)return;d=nameForUserID(c[0]).domain,n=actionString+"slaps @"+d+"/ around a bit with a large trout";break;default:return}}else 1<a.length&&"/"==a[1]&&(n=n.substring(1));n=replaceNames(n),encryptIfNeeded(s,n,e).then(e=>{let a={action:"sendMessage",conversation:s,from:domain,message:e};replying&&(a.replying=replying.message,replying=!1,updateReplying()),t&&(a.signature=t),imTyping=!1,ws("ACTION",a)})}function markSeen(e){ws("ACTION",{action:"markSeen",conversation:conversation,domain:domain,id:e})}async function createConversation(s){return conversations[s.id]=s,new Promise(e=>{let a=getOtherUser(s.id);a?makeSecret(s.id).then(()=>{$("#conversations .private table tr[data-id="+s.id+"]").remove(),$("#conversations .private table").prepend(conversationRow(s.id,a)),updateAvatars(),e()}):e()})}function goto(e,a){a?window.open(e,"_blank"):window.location=e}function sizeInput(){if("chat"==page){let e=$(".input textarea");e.css("height","1px");var a=e[0].scrollHeight;200<a&&(a=200),e.css("height",a+"px")}}function inputEnabled(e,a=!1){var s;if(a)switch(a){case"locked":s=".locked";break;case"verify":s=".verify";break;case"empty":s=".noConversations"}e?($(".inputHolder div:not(.input)").removeClass("shown"),$(".input").removeClass("hidden"),$(".input #message").attr("disabled",!1),isMobile()&&(!isMobile()||$("#conversations.showing").length)||$(".popover.shown").length||$(".input #message").focus()):($(".inputHolder div:not(.input)").removeClass("shown"),$(".input #message").attr("disabled",!0),$(".input").addClass("hidden"),$(".inputHolder "+s).addClass("shown"))}function updateActiveConversation(e){$("#conversations tr.active").removeClass("active"),$("#conversations tr[data-id="+e+"]").addClass("active")}function messageTabForConversation(e){isGroup(e)?switchMessageTab("channels"):switchMessageTab("private")}function switchMessageTab(e){$("#conversations .sections .section").removeClass("shown"),$("#conversations .tabs .tab").removeClass("active"),$("#conversations .sections .section."+e).addClass("shown"),$("#conversations .tabs .tab[data-tab="+e+"]").addClass("active")}function updateMessageTabs(){var e=$("#conversations .section.channels tr.unread.mentions"),s=0,e=($.each(e,(e,a)=>{$(a).data("id")!==conversation&&(s+=1)}),$("#conversations .section.private tr.unread")),t=0;$.each(e,(e,a)=>{$(a).data("id")!==conversation&&(t+=1)}),s?$("#conversations .tabs .tab[data-tab=channels]").addClass("notification"):$("#conversations .tabs .tab[data-tab=channels]").removeClass("notification"),t?$("#conversations .tabs .tab[data-tab=private]").addClass("notification"):$("#conversations .tabs .tab[data-tab=private]").removeClass("notification"),s||t?$(".header .left").addClass("notification"):$(".header .left").removeClass("notification")}function activeConversation(e){updateActiveConversation(e),$("#conversations tr[data-id="+e+"]").removeClass("unread"),$("#conversations tr[data-id="+e+"]").removeClass("mentions"),$(".input #message").val(""),nameForUserID(domain).locked?inputEnabled(!1,"verify"):$("#conversations tr[data-id="+e+"]").hasClass("locked")?inputEnabled(!1,"locked"):inputEnabled(!0),updateConversationHeader(e),isGroup(e)?$("#holder").attr("data-type","group"):$("#holder").attr("data-type","private"),e!=conversation&&(conversation=e,localStorage.setItem("conversation",conversation),updateActiveConversation(e),messageTabForConversation(conversation),updateMessageTabs(),$("#users .searching.shown").length&&updateSearchView(),$("#messages").empty(),$("#chats .content .needSLD").remove(),messages=[],replying=!(unexpandedLinks=[]),updateReplying(),close(),loadingConversations||loadMessages(conversation),updateUsers())}function getOtherUserID(e){e=conversations[e];return Object.keys(e.users).filter(e=>e!==domain).join(", ")}function getOtherUser(e){var e=conversations[e],a=Object.keys(e.users).filter(e=>e!==domain).join(", ");return e.users[a]}function isGroup(e){try{if(conversations[e].group)return!0}catch(e){}return!1}function nameForUserID(e){var a=e;return users.filter(e=>e.id==a)[0]}function typingCell(){return'<td class="typingCell flex"><div class="message typing"><div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div></div></td>'}function conversationRow(s,t,n=!1){var i="";if(isGroup(s))return c=toUnicode(t),(o=(d=conversations[s]).latestMessage).message&&(i=toUnicode(nameForUserID(o.user).domain)+'<span class="decrypt">'+replaceIds(o.message,!1)+"</span>"),r=o="",Object.keys(d.users).includes(domain)||(o="locked",r='<div class="locked"><div class="icon lock" title="Locked"></div></div>'),'<tr data-id="'+s+'" class="'+o+'"><td class="avatar">'+r+'<div class="fallback">#</div></td><td class="title">'+c+'<div class="subtitle">'+i+"</div></td>"+typingCell()+"</tr>";{var o="",r="",d=(t.claimed?t.locked&&(o="locked",r='<div class="locked"><div class="icon lock" title="Locked"></div></div>'):(o="unclaimed",r='<div class="unclaimed"><div class="icon warning" title="Unclaimed"></div></div>'),conversations[s].latestMessage),c=(d.message&&(i=toUnicode(conversations[s].users[d.user].domain)+'<span class="decrypt">'+d.message+"</span>"),getOtherUserID(s));let e=toUnicode(t.domain),a=String.fromCodePoint(e.codePointAt(0));d="";return n&&t.domain!==e&&(d='<div class="decoded">('+t.domain+")</div>"),'<tr data-id="'+s+'" class="'+o+'"><td class="avatar">'+r+'<div class="favicon" data-id="'+c+'" data-domain="'+t.domain+'"></div><div class="fallback">'+a.toUpperCase()+'</div></td><td class="title">'+e+"/"+d+'<div class="subtitle">'+i+"</div></td>"+typingCell()+"</tr>"}}function userRow(e){let a=toUnicode(e.domain),s=String.fromCodePoint(a.codePointAt(0));return'<tr class="user" data-id="'+e.id+'" data-name="'+a+'"><td class="avatar"><div class="favicon" data-id="'+e.id+'" data-domain="'+e.domain+'"></div><div class="fallback">'+s.toUpperCase()+'</div></td><td class="title">'+a+"/</td></tr>"}function messageAvatar(e,a){let s=String.fromCodePoint(a.codePointAt(0));return'<div class="avatar"><div class="favicon" data-id="'+e+'" data-domain="'+a+'"></div><div class="fallback">'+s.toUpperCase()+"</div></div>"}function isAction(e){return e.substring(0,8)===actionString}function replaceSpecialMessages(a,e=!0){var s,t="";try{var n=JSON.parse(a),t=n.attachment?(s="sent an attachment."," "):n.payment?(s="sent a payment."," "):(s=a,": ")}catch(e){isAction(a)?s=a.substring(7):(s=a,t=": ")}return s=e?t+s:s}function updateSubtitle(e,a){a=replaceIds(decodeEntities(decodeEntities(a)),!1);subtitle=replaceSpecialMessages(a),e.text(subtitle),e.removeClass("decrypt")}function htmlEntities(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function decryptConversationSubtitle(e){let a=$("#conversations tr[data-id="+e+"] .title .subtitle span.decrypt");var s,t;a.length&&(s=conversations[e].key||null,t=a.text(),conversations[e].group?updateSubtitle(a,t):s&&decryptMessage(t,s,e).then(e=>{updateSubtitle(a,e)}))}function unescape(e){return(e+"===".slice((e.length+3)%4)).replace(/-/g,"+").replace(/_/g,"/")}function escape(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function shareLink(){var e={session:key,privkey:keys.privateKeyJwk.d,settings:settings},e=JSON.stringify(e),e=btoa(e);return"https://"+host+"/sync#"+e}function setupShare(){var e;$("#qrcode").empty(),$("#qrcode").html('<div id="qrlogo"><img draggable="false" src="/assets/img/handshake"></div>'),$("#qrcode canvas").length||(e=shareLink(),new QRCode($("#qrcode")[0],{text:e,width:200,height:200,colorLight:css.getPropertyValue("--tertiaryBackground"),colorDark:css.getPropertyValue("--primaryForeground"),correctLevel:QRCode.CorrectLevel.L})),$("#qrcode img").attr("draggable","false")}function setPublicKey(){return api({action:"setPublicKey",pubkey:JSON.stringify(keys.publicKeyJwk)})}function getPublicKey(){return api({action:"getPublicKey"})}function loadSettings(){localStorage.settings&&(settings=JSON.parse(localStorage.settings),$.each(settings,(e,a)=>{root.style.setProperty("--"+e,a)}))}function getInvite(e){return api({action:"getInvite",code:e})}function onLoad(){switch(page){case"id":"undefined"!=typeof invite&&invite.length?getInvite(invite).then(e=>{if(e.success&&e.tld)tld=e.tld,$("#addDomain input[name=domain]").remove(),$("#addDomain .or").remove(),$("#addDomain select[name=tld]").empty(),$("#addDomain select[name=tld]").append('<option value="'+tld+'">'+toUnicode(tld)+"</option>"),$("#addDomain input[name=sld]").attr("placeholder","Choose a name"),$(".button[data-action=newDomain]").click();else{$("#addDomain").empty(),$(".button[data-action=newDomain]").click();let e=$('<div class="error response" />');e.html("That invite code isn't valid."),$("#addDomain").append(e)}}):listTLD().then(e=>{e=e.tlds;$.each(e,(e,a)=>{a=$('<option value="'+a+'">'+toUnicode(a)+"</option>");$("#addDomain select[name=tld]").append(a)}),getDomains().then(e=>{$("#manageDomains .domains").empty(),$("#manageDomains").show();var n=!1;if(e.success){if(domains=e.domains,!Object.keys(domains).length)return void $("#manageDomains .button").click();$.each(domains,(e,a)=>{var s=$('<div class="domain" />'),e=(s.attr("data-id",e),s.attr("data-name",a.domain),$("<div />"));e.append(toUnicode(a.domain)+"/"),a.locked?e.append(" (Unverified)"):n=!0,s.html(e);let t=$('<div class="actions" />');a.locked&&t.append('<div class="action link" data-action="reverifyDomain">Verify</div>'),t.append('<div class="icon action delete" data-action="deleteDomain"></div>'),s.append(t),$("#manageDomains .domains").append(s)})}n&&$("#startChatting").removeClass("hidden")})});break;case"chat":getDomains().then(e=>{e.success&&(domains=e.domains,Object.keys(domains).length?(setupDomainSelect(),Object.keys(domains).includes(localStorage.domain)?(domain=localStorage.domain,$(".header .domains option[value="+domain+"]").prop("selected",!0)):(domain=Object.keys(domains)[0],localStorage.setItem("domain",domain)),getUsers().then(e=>{e.success&&(users=e.users,loadConversations(),updateVerified())})):goto("/id"))}),loadSettings(),sizeInput(),setupShare(),setupNotifications(),setTimeout(()=>{websocket()},1e3),setInterval(()=>{ping()},1e3);break;case"sync":try{var e=unescape(window.location.hash.substr(1)),a=atob(e);let s=JSON.parse(a);key=s.session,s.settings&&(settings=s.settings,localStorage.setItem("settings",JSON.stringify(settings))),getPublicKey().then(e=>{if(e.success){let a=JSON.parse(e.pubkey);importKey(a.x,a.y,s.privkey).then(e=>{keys={privateKeyJwk:e,publicKeyJwk:a},localStorage.setItem("session",key),localStorage.setItem("keys",JSON.stringify(keys)),goto("/")})}})}catch(e){$("body[data-page=sync] .response").html("This link is invalid :/")}}}function onLoadAction(e){localStorage.removeItem("action");var e=e.split(":"),a=e[0],s=e[1];switch(a){case"message":s=toUnicode(s)+"/",$(".popover[data-name=startConversation] input[name=domain]").val(s),popover("startConversation"),$(".popover[data-name=startConversation] input[name=message]").focus();break;case"channel":var t=Object.keys(conversations).filter(e=>conversations[e].name==s);t.length&&activeConversation(t[0])}window.location.replace("#"),"function"==typeof window.history.replaceState&&history.replaceState({},"",window.location.href.slice(0,-1))}function setupDomainSelect(){$(".header .domains select").empty(),$.each(domains,(e,a)=>{var s="";a.locked&&(s=" (Unverified)"),$(".header .domains select").append('<option value="'+e+'">'+toUnicode(a.domain)+"/"+s+"</option>")}),$(".header .domains select").append('<optgroup label="-----------------"></optgroup>'),$(".header .domains select").append('<option value="manageDomains">Manage Domains</option>')}async function popover(n){close(!0);let e=new Promise(s=>{switch(n){case"syncSession":s();break;case"pay":$(".popover[data-name="+n+"]").find(".response").html(""),s();let a=getOtherUser(conversation).domain;api({action:"getAddress",domain:getOtherUserID(conversation)}).then(e=>{$(".popover[data-name="+n+"]").find(".loading").removeClass("shown"),e.success?($(".popover[data-name="+n+"]").find(".subtitle").html(a+"/ is able to accept payments!"),$(".popover[data-name="+n+"]").find("input[name=address]").val(e.address),$(".popover[data-name="+n+"]").find(".content").addClass("shown"),$(".popover[data-name="+n+"]").find("input[name=hns]").focus()):($(".popover[data-name="+n+"]").find(".response").addClass("error"),$(".popover[data-name="+n+"]").find(".response").html(e.message))});break;case"settings":var e=nameForUserID(domain),t=e.tld;t?($(".popover[data-name="+n+"]").find("input[name=avatar]").parent().removeClass("hidden"),$(".popover[data-name="+n+"]").find("input[name=avatar]").val(e.avatar),["hnschat","theshake"].includes(t)?($(".popover[data-name="+n+"]").find("input[name=address]").parent().removeClass("hidden"),api({action:"getAddress",domain:domain}).then(e=>{e.address&&$(".popover[data-name="+n+"]").find("input[name=address]").val(e.address),s()})):($(".popover[data-name="+n+"]").find("input[name=address]").parent().addClass("hidden"),s())):($(".popover[data-name="+n+"]").find("input[name=avatar]").parent().addClass("hidden"),$(".popover[data-name="+n+"]").find("input[name=address]").parent().addClass("hidden"),s());break;case"mention":case"emojis":e=$(".inputHolder").outerHeight()+10;$(".popover[data-name="+n+"]").css("bottom",e+"px"),s();break;default:s()}});e.then(()=>{$("#blackout").addClass("shown"),$("#messageHolder").addClass("noScroll"),$(".popover[data-name="+n+"]").addClass("shown"),["syncSession"].includes(n)||$(".popover[data-name="+n+"]").find("input:visible:first").focus(),"emojis"===n&&$(".popover[data-name=emojis] .body .grid").scrollTop(0)})}function copyToClipboard(e){let a=e.parent().find("input")[0];a.select(),a.setSelectionRange(0,99999),navigator.clipboard.writeText(a.value),a.setSelectionRange(0,0),e.addClass("copied"),setTimeout(()=>{e.removeClass("copied")},1e3)}function close(e=!1){$("#blackout").removeClass("shown"),$("#mention").removeClass("shown"),$(".popover.shown").find("input").val(""),$(".popover.shown").find(".response").html(""),$(".popover.shown").find(".content").removeClass("shown"),$(".popover.shown").find(".loading").addClass("shown"),$(".popover.shown").removeClass("shown"),$("#messageHolder").removeClass("noScroll"),$(".popover[data-name=emojis] .grid .section").removeClass("hidden"),$(".popover[data-name=emojis] .grid .section[data-name=Search]").addClass("hidden"),e||$(".messageRow .hover.visible").removeClass("visible")}function showChat(e){e?socketReady()&&$("body[data-page=chat] .connecting").addClass("hidden"):$("body[data-page=chat] .connecting").removeClass("hidden")}function socketReady(){return!(!socket||1!=socket.readyState)}function websocket(){socket&&3!==socket.readyState||((socket=new WebSocket("wss://ws."+host)).onopen=e=>{showChat(1),socket.send("IDENTIFY "+key),typing=setInterval(()=>{sendTyping(),updateTypingViews(),updateTypingStatus()},250)},socket.onmessage=e=>{parse(e.data)},socket.onclose=e=>{showChat(0),socket=null,setTimeout(()=>{websocket()},1e3)})}function unlockIfLocked(e,a){conversations[e].users[a].locked=0,conversations[e].users[a].claimed=1,conversation==e&&(updateConversationHeader(e),inputEnabled(!0))}function updateConversationHeader(e){var a;$(".messageHeader table").empty(),isGroup(e)?(a=conversations[e].name,$(".messageHeader table").append(conversationRow(e,a))):(a=getOtherUser(e),$(".messageHeader table").append(conversationRow(e,a,!0))),updateAvatars()}function parse(e){var e=e.match(/(?<command>[A-Z]+)\s(?<body>.+)/),a=e.groups.command;let s=JSON.parse(e.groups.body);switch(a){case"MESSAGE":Object.keys(conversations).includes(s.conversation)&&Object.keys(conversations[s.conversation].users).includes(domain)&&(Object.keys(conversations[s.conversation].users).includes(s.user)&&(Object.keys(typers).includes(s.user)&&(delete typers[s.user],updateTypingViews()),Object.keys(domains).includes(s.user)||(conversations[s.conversation].unreadMessages=1,s.message.includes("@"+domain)&&(conversations[s.conversation].unreadMentions=1)),unlockIfLocked(s.conversation,s.user)),loadingMessages+=1,prepareMessage(s,!1),conversation==s.conversation&&s.user!==domain&&markSeen(s.id),t={message:s.message,time:s.time,user:s.user},conversations[s.conversation].latestMessage=t,isGroup(s.conversation)&&!Object.keys(conversations[s.conversation].users).includes(s.user)&&(t=users.filter(e=>e.id==s.user)).length&&(t=t[0],conversations[s.conversation].users[t.id]={domain:t.domain},updateUsers()),updateConversation(s));break;case"REACTION":if(Object.keys(conversations).includes(s.conversation)&&Object.keys(conversations[s.conversation].users).includes(s.from)&&conversation==s.conversation){var t=messages.filter(e=>e.id==s.message);if(t.length){let e=t[0];Object.keys(e.reactions).includes(s.reaction)||(e.reactions[s.reaction]=[]),e.reactions[s.reaction].includes(s.from)?(t=e.reactions[s.reaction].indexOf(s.from),e.reactions[s.reaction].splice(t,1),Object.keys(e.reactions[s.reaction]).length||delete e.reactions[s.reaction]):e.reactions[s.reaction].push(s.from),updateReactions(e)}}break;case"DELETE":if(conversation==s.conversation){let e=$(".messageRow[data-id="+s.message+"]");t=e.next();e.remove(),t.length?stylizeMessage(t):stylizeMessage($("#messages > .messageRow").last())}s.latestMessage&&(conversations[s.conversation].latestMessage=s.latestMessage,updateConversation({conversation:s.conversation}));let e=$("#messages > .messageRow").last();e.hasClass("date")&&e.remove();break;case"CONVERSATION":createConversation(s).then(()=>{if(started&&Object.keys(s.users).includes(started.from)){let e=getOtherUser(s.id);(e.domain=started.to)&&($("#conversations").removeClass("showing"),$("#users").removeClass("showing"),activeConversation(s.id),sendMessage(s.id,started.message),started=null)}});break;case"TYPING":typers[s.from]=s;break;case"LOCKED":t=s;$.each(t,(e,a)=>{domains[a].locked=1}),loadConversations(),setupDomainSelect();break;case"USERS":users=s}}function updateReactions(d){let c=$("#messages .messageRow[data-id="+d.id+"]");c.length&&(c.find(".reactions").empty(),$.each(Object.keys(d.reactions),(e,a)=>{let s=$('<div class="reaction" />'),t=$("<div />"),n=$('<div class="count" />');s.attr("data-reaction",a),t.html(a),n.html(d.reactions[a].length);var i=d.reactions[a];let o=[];$.each(i,(e,a)=>{a=toUnicode(nameForUserID(a).domain);o.push(a)});i=o[0];if(1<o.length){let e=o.slice(0,o.length-1);var r=o.pop(),i=e.join(", ")+" and "+r}s.attr("title",i),d.reactions[a].includes(domain)&&s.addClass("self"),s.append(t),s.append(n),c.find(".reactions").append(s)}),c.find(".reactions .reaction").length?c.find(".holder.react").addClass("shown"):c.find(".holder.react").removeClass("shown"))}function updateTypingViews(){var t=[],a=($('<div class="messageRow typing first last"><div class="message"><div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div></div></div>'),Object.keys(typers).length&&$.each(typers,(e,a)=>{if(Date.now()/1e3-a.time<=3){if(a.to==conversation)try{var s=nameForUserID(a.from).domain;t.push(toUnicode(s)+"/")}catch(e){}$("#conversations tr[data-id="+a.to+"] .typingCell").addClass("shown")}else $("#conversations tr[data-id="+a.to+"] .typingCell").removeClass("shown"),delete typers[a.from]}),t.length);if(a){var s="";if(1<a)if(5<a)s="Many users are typing...";else{let e=t.slice(0,t.length-1);a=t.pop(),s=e.join(", ")+" and "+a+" are typing..."}else s=t[0]+" is typing...";$("#typing .message").html(s),$("#typing").addClass("shown")}else $("#typing").removeClass("shown");a=$("#conversations tr .typingCell.shown");$.each(a,(e,a)=>{let s=$(a).parent().data("id");var t;isGroup(s)?Object.keys(typers).length&&Object.keys(typers).filter(e=>typers[e].to==s).length||$(a).removeClass("shown"):(t=getOtherUserID(s),Object.keys(typers).includes(t)||$(a).removeClass("shown"))})}function updateTypingStatus(){lastTyped&&(Date.now()-lastTyped>typingDelay?imTyping=!1:$(".input #message").is(":focus")&&""!==$(".input #message").val()&&(imTyping=!0))}function sendTyping(){var e,a=$(".input #message").val();a&&"/"===a[0]||imTyping&&(a=!1,typingSent?(e=Date.now()-typingSent,typingSendDelay<=e&&(a=!0)):a=!0,a&&(typingSent=Date.now(),ws("ACTION",{action:"typing",from:domain,to:conversation})))}function toggleSignature(){$(".icon.signature").hasClass("on")?($(".icon.signature").removeClass("on"),$(".input #signature").removeClass("shown"),$(".input #signature").val(""),$(".input #message").focus()):($(".icon.signature").addClass("on"),$(".input #signature").addClass("shown"),$(".input #signature").focus())}function showOrHideAttachments(){let e=$("#attachments");e.find(".attachment").length?(e.addClass("shown"),fixScroll()):e.removeClass("shown")}async function setSession(e=0){return new Promise(a=>{localStorage.session?(key=localStorage.session,a(key)):startSession().then(e=>{e.success&&(key=e.session,localStorage.setItem("session",key),a(key))})})}async function setKeys(){return new Promise(a=>{localStorage.keys?(keys=JSON.parse(localStorage.keys),a(keys)):generateKeys().then(e=>{keys=e,localStorage.setItem("keys",JSON.stringify(keys)),setPublicKey().then(e=>{a(keys)})})})}function verifySession(){return api({action:"verifySession",pubkey:JSON.stringify(keys.publicKeyJwk)})}function regexEscape(e){return e.replace(/[.*+\'\`\-\_?^$\{\}\(\)\|\[\\\]\/\#\&\!\+\@\:\~\=]/g,"\\$&")}function tabComplete(){var e="",a="",s=$("#message").val(),t=[],t=("/"===s[0]&&1<s.length&&"/"!==s[1]&&(e="/",a=" ",t=commands,s=s.substring(1)),t.sort(),t.filter(e=>{if((e=String(e)).length)return regexEscape(e.substr(0,s.length).toLowerCase())==regexEscape(s.toLowerCase())}));t.length&&$("#message").val(e+t[0]+a)}function getBrowser(){return-1!=navigator.userAgent.indexOf("Chrome")?"chrome":-1!=navigator.userAgent.indexOf("Firefox")?"firefox":-1!=navigator.userAgent.indexOf("MSIE")?"ie":-1!=navigator.userAgent.indexOf("Edge")?"edge":-1!=navigator.userAgent.indexOf("Safari")?"safari":-1!=navigator.userAgent.indexOf("Opera")?"opera":"other"}function categoryForEmoji(t){var n=!1;return $.each(Object.keys(emojiCategories),(e,a)=>{let s=emojiCategories[a];if(s.includes(t.category))return n=a,!1}),n||!1}function openConversationWith(e){nameForUserID(domain).locked||($(".popover[data-name=startConversation] input[name=domain]").val(e),popover("startConversation"),setTimeout(()=>{$(".popover[data-name=startConversation] input[name=message]").focus()},1))}function setupNotifications(){"Notification"in window&&navigator.serviceWorker&&"granted"!==Notification.permission&&"blocked"!==Notification.permission&&Notification.requestPermission(e=>{"granted"===e&&"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js",{scope:"/"})})}function sendNotification(s,t,n){"Notification"in window&&navigator.serviceWorker&&"granted"==Notification.permission&&navigator.serviceWorker.getRegistration().then(e=>{notificationSound.play();var a={body:replaceSpecialMessages(t,!1),icon:"/assets/img/logo.png",vibrate:[100,50,100],data:{dateOfArrival:Date.now(),primaryKey:1},conversation:n};new Notification(s,a).onclick=()=>{activeConversation(n),window.focus()}})}function updateReplying(){var e;replying?(e="Replying to "+toUnicode(nameForUserID(replying.sender).domain)+"/",$("#replying .message").html(e),$("#replying").addClass("shown")):($("#replying").removeClass("shown"),$("#replying .message").html(""))}function updateVerified(){nameForUserID(domain).locked?$("body").addClass("unverified"):$("body").removeClass("unverified")}function getWordForPosition(e,a){e.indexOf(a);e=e.substr(0,a);return 0<e.indexOf(" ")?e.split(" ").length-1:0}function setCaretPosition(e,a){e.setSelectionRange?(e.focus(),e.setSelectionRange(a,a)):e.createTextRange&&((e=e.createTextRange()).collapse(!0),e.moveEnd("character",a),e.moveStart("character",a),e.select())}function mentions(e){var a=[];let s=$(e.currentTarget),t=s.val();var e=t.split(" "),n=s[0].selectionStart;let i=e[getWordForPosition(t,n)];"@"===i[0]&&1<i.length&&($("#mention .body .list").empty(),a=Object.keys(conversations[conversation].users).filter(e=>{var e=nameForUserID(e),a=Array.from(toUnicode(e.domain)).slice(0,Array.from(i).length-1).join("").toLowerCase(),s=i.toLowerCase();return!e.locked&&"@"+a===s}).slice(0,10),$.each(a,(e,a)=>{a=userRow(nameForUserID(a));$("#mention .body .list").append(a)}),$("#mention .user").first().addClass("active"),updateAvatars()),a.length?popover("mention"):close()}async function sendWithBob(e,a){const s=await bob3.connect();if(!a)return{message:"Please enter an amount."};try{return await s.send(e,a)}catch(e){return e}}async function signWithBob(e,a,s){const t=await bob3.connect();try{return await t.signWithName(a,s)}catch(e){return e}}async function signWithMetaMask(e,a,s){var t=await ethereum.request({method:"eth_requestAccounts"});try{var n=t[0];return{account:n,signature:await ethereum.request({method:"personal_sign",params:[s,n]})}}catch(e){return e}}async function verifySignature(e,a,s=null){return api({action:"verifySignature",domain:e,account:s,signature:a})}function setActive(e){isActive=!!e}function ping(){var e={action:"ping",from:domain};socketReady()&&ws("ACTION",e)}function nameFromTarget(e){var a;return e.hasClass("favicon")?a=e.data("domain")+"/":e.parent().hasClass("messageRow")||e.parent().parent().hasClass("messageRow")||e.parent().parent().parent().hasClass("messageRow")?e.hasClass("user")&&(a=e.text()):e.hasClass("inline nick")?a=e.text().substring(1):void 0!==e.data("name")&&(a=e.data("name")+"/"),a||!1}function userFromName(a){var e=users.filter(e=>a==toUnicode(e.domain));return!!e.length&&e[0]}$(()=>{(urlAction=window.location.hash.substr(1))?localStorage.setItem("action",urlAction):localStorage.action&&(urlAction=localStorage.action),"sync"==(page=$("body").data("page"))?onLoad():setSession().then(()=>{setKeys().then(()=>{verifySession().then(e=>{e.success?onLoad():"V2-"!==key.substring(0,3)?(delete key,delete keys,localStorage.clear(),window.location.reload()):alert(e.message)})})}),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||$("body").addClass("desktop"),$(window).on("focus",e=>{let a=$(e.currentTarget),s=("message"!==a.attr("id")&&setActive(!0),$("#messages > .messageRow[data-id]").last());e=s.data("id");e&&loadMessages(conversation,{after:e})}),$(window).on("blur",()=>{setActive(!1)}),$(document).on("mouseleave",()=>{setActive(!1)}),$(document).on("mouseenter",()=>{setActive(!0)}),$(document).on("keydown",a=>{var e=a.keyCode||a.which,s=$(a.currentTarget);if(s.prop("tagName")||(s=$(a.target)),27==e)return a.preventDefault(),$("#replying.shown").length&&$(".action[data-action=removeReply]").click(),void($("#blackout").is(":visible")&&close());if(!["domain","tld","sld"].includes(s.attr("name"))||/[a-zA-Z0-9\-\.\/]/.test(a.key)||a.preventDefault(),["INPUT","TEXTAREA"].includes(s.prop("tagName"))){if(13==e){a.preventDefault();let e=s.closest(".body").find(".button");return void e.click()}if(!s.hasClass("tab"))return void(9==e&&(a.preventDefault(),"message"===s.attr("id")&&tabComplete()))}$("#message").is(":focus")||$("#blackout").is(":visible")||1!=a.key.length&&9!=e||a.ctrlKey||a.metaKey||(9==e&&a.preventDefault(),$("#message").focus())}),$("html").on("focus click","#message",e=>{mentions(e)}),$("html").on("click","#mention tr",e=>{$("#mention tr").removeClass("active"),$(e.currentTarget).addClass("active");e="@"+$("#mention tr.active .title").html();let a=$(".input #message"),s=a.val(),t=s.split(" ");for(var n=a[0].selectionStart,i=getWordForPosition(s,n),o=(t[i],t[i]=e+" ",0),r=0;r<t.length;r++)if(o+=t[r].length,r==i){o+=r;break}n=t.join(" ");a.val(n),setCaretPosition(a[0],o)}),$("html").on("input paste keyup","#users input[name=search]",e=>{27==(e.keyCode||e.which)?$("#users .action.close").click():searchUsers($(e.currentTarget).val())}),$("html").on("click","#users .action[data-action=searchUsers]",()=>{updateSearchView()}),$("html").on("mousemove","#mention tr",e=>{$("#mention tr.active").removeClass("active"),$(e.currentTarget).addClass("active")}),$("html").on("input paste keyup",".input #message",a=>{var s,t=a.keyCode||a.which;if(27!==t){if("keyup"===a.type&&$("#mention").hasClass("shown")){let e=$("#mention tr.active");switch(t){case 38:case 40:return a.preventDefault(),e.removeClass("active"),s=38==t?e[0].previousSibling||$("#mention .body .list").children().last():e[0].nextSibling||$("#mention .body .list").children().first(),void $(s).addClass("active");case 27:return a.preventDefault(),void $("#mention").removeClass("shown")}}mentions(a),sizeInput()}}),$("html").on("keydown",".input #message, .input #signature",a=>{var s=a.keyCode||a.which;switch(s){case 38:case 40:case 27:return}if($(a.currentTarget).val()&&"/"!==$(a.currentTarget).val()[0]&&1==a.key.length&&(lastTyped=Date.now()),$("#mention").hasClass("shown"))switch(s){case 9:case 13:return a.preventDefault(),void $("#mention tr.active").click()}else if(13==s){a.preventDefault();var s=$(".input #message").val(),t=$(".input #signature").val();let e=$("#attachments .attachment");e.find(".uploading").length||($.each(e,(e,a)=>{a=$(a).data("id");sendMessage(conversation,JSON.stringify({hnschat:1,attachment:a}))}),s.length&&sendMessage(conversation,s,t),$(".input #message").val(""),$(".input #signature").val(""),$("#attachments").empty(),showOrHideAttachments())}}),$("html").on("change",".domains select",e=>{e=$(e.currentTarget).val();"manageDomains"===e?goto("/id"):(showChat(!1),domain=e,localStorage.setItem("domain",domain),loadConversations(),$("#conversations").addClass("showing"),updateVerified())}),$("html").on("click",".button,.link",e=>{let s=$(e.currentTarget);e=s.hasClass("disabled");if(!e){var i,o,r,d,c,l=s.parent().find(".response");(l=l.length?l:s.parent().parent().find(".response")).html(""),l.removeClass("error");let a=s,e=a.data("action"),n=a.html();switch(a.hasClass("button")&&(a.addClass("disabled"),a.html("Loading...")),e){case"addDomain":case"verifyDomain":(i=$(".form #"+e+" input[name=domain]").val())||(sld=$(".form #"+e+" input[name=sld]").val(),c=$(".form #"+e+" select[name=tld]").val(),e="addSLD");break;case"startConversation":i=$(".popover[data-name=startConversation] input[name=domain]").val(),d=$(".popover[data-name=startConversation] input[name=message]").val();break;case"reverifyDomain":i=s.closest(".domain").data("name"),e="addDomain";break;case"startChatting":"undefined"!=typeof invite&&invite.length?goto("/#channel:"+c):goto("/");break;case"sendHNS":r=s.parent().find("input[name=address]").val(),i=s.parent().find("input[name=hns]").maskMoney("unmasked")[0];break;case"submitDonation":o=$(".popover[data-name=donate] input[name=usd]").maskMoney("unmasked")[0]}switch(e){case"newDomain":case"addDomain":case"addSLD":case"verifyDomain":case"reverifyDomain":case"sendHNS":l.removeClass("error"),l.html("")}switch(e){case"newDomain":$("#addDomain input[name=domain]").val(""),$("#id .section").hide(),$("#addDomain").show(),$("#addDomain input[name=domain]").focus(),a.html(n),a.removeClass("disabled");break;case"addDomain":addDomain(i).then(e=>{e.success?($("#id .section").hide(),$("#verifyOptions input[name=domain]").val(i),$("#verifyDomain input[name=domain]").val(e.domain),$("#verifyDomain #code").html(e.code),".eth"===i.substring(i.length-4)?($("#verifyOptions .button[data-action=verifyDomainWithTXT]").addClass("disabled"),$("#verifyOptions .button[data-action=verifyDomainWithMetaMask]").removeClass("disabled")):($("#verifyOptions .button[data-action=verifyDomainWithTXT]").removeClass("disabled"),$("#verifyOptions .button[data-action=verifyDomainWithMetaMask]").addClass("disabled")),i.includes(".")?$("#verifyOptions .button[data-action=verifyDomainWithBob]").addClass("disabled"):$("#verifyOptions .button[data-action=verifyDomainWithBob]").removeClass("disabled"),$("#verifyOptions").show()):(l.addClass("error"),l.html(e.message)),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"))});break;case"addSLD":addSLD(sld,c).then(e=>{e.success?(localStorage.setItem("domain",e.domain),$("#id .section").hide(),$(".section#startChatting").show()):(l.addClass("error"),l.html(e.message)),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"))});break;case"verifyDomainWithTXT":$("#verifyOptions").hide(),$("#verifyDomain").show(),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"));break;case"verifyDomainWithBob":var m=$("#verifyDomain input[name=domain]").val(),v=$("#verifyOptions input[name=domain]").val(),p=$("#verifyDomain #code").html();signWithBob(m,v,p).then(e=>{e.message?(l.addClass("error"),l.html("Error: "+e.message)):verifySignature(m,e).then(e=>{e.success?(localStorage.setItem("domain",m),$("#id .section").hide(),onLoad()):(l.addClass("error"),l.html(e.message))}),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"))});break;case"verifyDomainWithMetaMask":m=$("#verifyDomain input[name=domain]").val(),v=$("#verifyOptions input[name=domain]").val(),p=$("#verifyDomain #code").html();signWithMetaMask(m,v,p).then(e=>{e.message?(l.addClass("error"),l.html("Error: "+e.message)):verifySignature(m,e.signature,e.account).then(e=>{e.success?(localStorage.setItem("domain",m),$("#id .section").hide(),onLoad()):(l.addClass("error"),l.html(e.message)),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"))})});break;case"verifyDomain":verifyDomain(i).then(e=>{e.success?(localStorage.setItem("domain",i),$("#id .section").hide(),onLoad()):(l.addClass("error"),l.html(e.message)),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"))});break;case"startConversation":let s=userFromName(i.replace(/^[ ./]+/,"").replace(/[ ./]+$/,"")).domain;s.length?d.length?checkName(domain,s).then(e=>{var a;e.success?(a={action:"startConversation",from:domain,to:s,message:d},ws("ACTION",started=a),close()):(l.addClass("error"),l.html(e.message))}):(l.addClass("error"),l.html("Please enter a message.")):(l.addClass("error"),l.html("Please enter a name.")),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"));break;case"submitDonation":o?goto("https://btcpay.eskimosoftware.net/api/v1/invoices?storeId=559mPWkGX7vkXjjvC7kFhtUEhBosN7TaHrbtBhjQK7UU&currency=USD&price="+o):(l.addClass("error"),l.html("Please enter an amount.")),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"));break;case"sendHNS":sendWithBob(r,i).then(e=>{e.message?(l.addClass("error"),l.html("Error: "+e.message)):e.hash&&(e={hnschat:1,payment:e.hash,amount:i},sendMessage(conversation,JSON.stringify(e)),close()),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"))});break;case"saveSettings":v=$(".popover[data-name=settings] input.color");$.each(v,(e,a)=>{var s=$(a).attr("name"),a=$(a).val();settings[s]=a}),localStorage.setItem("settings",JSON.stringify(settings));let t={action:"saveSettings",domain:domain,settings:{}};v=$(".popover[data-name=settings] input.remote"),$.each(v,(e,a)=>{var s=$(a).attr("name"),a=$(a).val();t.settings[s]=a}),t.settings=JSON.stringify(t.settings),api(t).then(e=>{e.success?(e.avatar&&(delete avatars[domain],nameForUserID(domain).avatar=e.avatar,$(".favicon.loaded[data-id="+domain+"]").removeClass("loaded"),updateAvatars()),setupShare(),close()):(l.addClass("error"),l.html(e.message)),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"))});break;case"purchaseSLD":goto("https://porkbun.com/tld/"+(c=toASCII(a.data("tld"))),!0),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"));break;case"createSLD":goto("/invite/"+(c=a.data("tld"))),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"));break;case"verifyName":goto("/id"),a.hasClass("button")&&(a.html(n),a.removeClass("disabled"));break;case"switchName":p=a.data("id");$(".header .domains select").val(p),$(".header .domains select").trigger("change")}}}),$("html").on("click","#conversations tr",e=>{$("#conversations").removeClass("showing");e=$(e.currentTarget).data("id");e!==conversation&&activeConversation(e)}),$("html").on("click",".action",t=>{let n=!1,i=$(t.currentTarget);var e=i.hasClass("disabled");if(!e){var o=i.data("action");switch(o){case"startConversation":nameForUserID(domain).locked||popover(o);break;case"startConversationWith":openConversationWith(i.closest(".body").find("span.subtitle").html());break;case"deleteDomain":let a=i.closest(".domain");api({action:"deleteDomain",domain:a.data("id")}).then(e=>{e.success&&a.remove()});break;case"signature":toggleSignature();break;case"donate":$(".popover[data-name=donate] input[name=usd]").maskMoney({prefix:"$ "});break;case"settings":$(".popover[data-name=settings] input[name=bubbleBackground]").val(css.getPropertyValue("--bubbleBackground").trim()),$(".popover[data-name=settings] input[name=bubbleSelfBackground]").val(css.getPropertyValue("--bubbleSelfBackground").trim()),$(".popover[data-name=settings] input[name=bubbleMentionBackground]").val(css.getPropertyValue("--bubbleMentionBackground").trim());break;case"syncSession":$(".popover[data-name=syncSession] input[name=session]").val(shareLink());break;case"pay":$(".popover[data-name=pay] input[name=hns]").maskMoney({suffix:" HNS",precision:6});break;case"file":$("#file")[0].click();break;case"removeAttachment":let e=i.parent().parent();e.remove(),showOrHideAttachments(),deleteAttachment(e.data("id"));break;case"close":close();break;case"reply":(replying={message:i.closest(".messageRow").data("id"),sender:i.closest(".messageRow").data("sender")}).message||(n=!0,replying={message:i.closest(".body").find("span.message").data("id"),sender:i.closest(".body").find("span.message").data("sender")}),updateReplying(),$(".input #message").focus();break;case"removeReply":replying=!1,updateReplying(),$(".input #message").focus();break;case"emojis":var r=i.closest(".input").length?"input":"message";setupEmojiView(t,r);break;case"deleteMessage":let s=i.closest(".messageRow").data("id");s||(n=!0,s=i.closest(".body").find("span.message").data("id")),ws("ACTION",{action:"deleteMessage",message:s,domain:domain});break;case"clipboard":copyToClipboard(i)}switch(o){case"donate":case"settings":case"syncSession":case"pay":case"emojis":popover(o)}n&&close()}}),$(window).on("contextmenu",t=>{let n=$(t.target);if(!(["INPUT","TEXTAREA"].includes(n.prop("tagName"))||n.hasClass("body")||n.hasClass("inline")&&!n.hasClass("nick")))if(t.preventDefault(),n.hasClass("user")||n.hasClass("favicon")||n.hasClass("inline nick")){var i=nameFromTarget(n);if(i){i=toUnicode(toASCII(rtrim(i,"/")))+"/";let e=$(".popover[data-name=userContext]");e.find("span.user").html(i),popover("userContext"),setContextMenuPosition(e,t)}}else if(n.closest(".messageRow").length){let e=n.closest(".messageRow").find(".message .body"),a=e.text(),s=(e.find("img").length&&(a="Attachment"),$(".popover[data-name=messageContext]"));if(s.find("span.message").html(a),s.find("span.message").data("id",n.closest(".messageRow").data("id")),s.find("span.message").data("sender",n.closest(".messageRow").data("sender")),s.find("li.action.delete").addClass("hidden"),isGroup(conversation)){var i=nameForUserID(domain),o=i.domain;let e=conversations[conversation];var r=e.name;e.admins;(e.tldadmin&&o===r||i.admin||e.admins.includes(domain))&&s.find("li.action.delete").removeClass("hidden")}popover("messageContext"),setContextMenuPosition(s,t)}}),$("html").on("keyup",".popover[data-name=emojis] input",a=>{let t=$(a.currentTarget).val().replace(/[^a-zA-Z0-9]/gi,"").toLowerCase();if(t){let e=$(".popover[data-name=emojis] .section:not([data-name=Search]) .emoji");a=e.filter((e,a)=>{var s=$(a).data("aliases");return $.each(s,(e,a)=>{s[e]=a.replace(/[^a-zA-Z0-9]/gi,"").toLowerCase()}),s.join("|").includes(t)});$(".popover[data-name=emojis] .grid .section[data-name=Search] .emojis").empty(),$.each(a,(e,a)=>{a=a.cloneNode(!0);$(".popover[data-name=emojis] .grid .section[data-name=Search] .emojis").append(a)}),$(".popover[data-name=emojis] .grid .section").addClass("hidden"),$(".popover[data-name=emojis] .grid .section[data-name=Search]").removeClass("hidden")}else $(".popover[data-name=emojis] .grid .section").removeClass("hidden"),$(".popover[data-name=emojis] .grid .section[data-name=Search]").addClass("hidden")}),$("html").on("click",".popover[data-name=emojis] .emoji",e=>{var a=$(".popover[data-name=emojis]").data("sender");let s=$(e.currentTarget);var t=s.html();switch(a){case"input":let e=$(".input #message");var n=e.val(),i=(Array.from(n),e[0].selectionStart),n=replaceRange(n,i,i,t);e.val(n),close(),$(".input #message").focus(),setCaretPosition(e[0],i+t.length);break;case"message":n=$(".messageRow .hover.visible").closest(".messageRow").data("id"),i=(close(),{action:"react",conversation:conversation,from:domain,message:n,reaction:t});ws("ACTION",i)}}),$("html").on("click",".reaction",e=>{let a=$(e.currentTarget);var e=a.closest(".messageRow").data("id"),s=a.data("reaction");ws("ACTION",{action:"react",conversation:conversation,from:domain,message:e,reaction:s})}),$("html").on("keyup",".popover[data-name=settings] input.color",e=>{let a=$(e.currentTarget);var e="--"+a.attr("name"),s=a.val();root.style.setProperty(e,s)}),$("html").on("change","#file",s=>{s=$(s.currentTarget)[0].files[0];if(s){var t=URL.createObjectURL(s);$("#attachments");let a=$('<div class="attachment" />');a.css("background-image","url("+t+")");t=$('<div class="uploading lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>');a.append(t);let e=$('<div class="removeHolder" />');t=$('<div class="icon action remove" data-action="removeAttachment" />'),t=(e.append(t),a.append(e),$("#attachments").append(a),showOrHideAttachments(),new FormData);t.append("file",s),t.append("key",key),upload(t,a).then(e=>{a.find(".uploading").remove(),e.success?a.attr("data-id",e.id):(alert(e.message),a.remove()),showOrHideAttachments(),$("#message").focus()})}}),$("html").on("click","#conversations .tabs .tab",e=>{switchMessageTab($(e.currentTarget).data("tab"))}),$("html").on("click","#blackout",()=>{close()}),$("html").on("click",".message.signed",a=>{if(!$(a.currentTarget).hasClass("signature")){let e=$(a.currentTarget).find(".signature");e.hasClass("shown")?e.removeClass("shown"):e.addClass("shown")}}),$("html").on("dblclick","#users .user, .messageRow .user, .messageRow .favicon, .inline.nick",e=>{e=nameFromTarget($(e.currentTarget));e&&openConversationWith(e)}),$("html").on("keyup","input",e=>{e.preventDefault(),13==e.which&&$(e.currentTarget).closest(".section").find(".button").click()}),$("html").on("click",".header .left",()=>{$("#users").removeClass("showing"),$("#conversations").toggleClass("showing")}),$("html").on("click",".header .right",()=>{$("#conversations").removeClass("showing"),$("#users").toggleClass("showing")}),$("#messageHolder").on("scroll",e=>{let a=$("#messageHolder");if(!loadingMessages){var s=a.outerHeight(),t=a[0].scrollTop,n=a[0].scrollHeight-a.height();if(n-s!=0)if(Math.floor(n+t)<1){loadingMessages=1;let e=$("#messages > .messageRow[data-id]").first();s=e.data("id");s&&loadMessages(conversation,{before:s})}}}),$(window).on("resize",()=>{sizeInput()}),log("Created by eskimo - https://skmo")});
